<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CONTROL DE ALUMNOS</title>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  padding: 24px;
  background: 
    linear-gradient(rgba(0,0,0,0), rgba(245,2,0,0)),
    url("fondo.jpg") center / cover no-repeat fixed;
  color: #999;
}

h1 {
  margin-bottom: 20px;
  font-size: 24px;
}


.fila {
  display: flex;
  flex-wrap: wrap;        /* CLAVE para m√≥vil */
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
  padding: 16px;
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
}

.nombre {
  flex: 1;
  font-weight: 600;
  font-size: 20px;
}

.circulos {
  display: flex;
  gap: 8px;
}

.circulo {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 2px solid #555;
  cursor: pointer;
}

.circulo.activo {
  background: green;
}

button {
  padding: 14px 22px;
  font-size: 16px;
  border-radius: 18px;
  border: none;
  cursor: pointer;
  background: #1976d2;
  color: white;
  min-height: 44px; /* tama√±o recomendado para dedo */
}

button:hover {
  opacity: 0.9;
}
/* MODAL */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.5);
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal.oculto { display: none; }

.modal-box {
  background: #fff;
  padding: 20px;
  min-width: 280px;
  position: relative;
}

.cerrar {
  position: absolute;
  top: 6px;
  right: 10px;
  cursor: pointer;
  font-weight: bold;
}

#fechaHora {
  position: fixed;
  top: 16px;
  right: 24px;
  font-size: 14px;
  font-weight: 600;
  color: white;
  background: rgba(0,0,0,0.45);
  padding: 8px 14px;
  border-radius: 12px;
  backdrop-filter: blur(4px);
  z-index: 1000;
}

input {
  font-size: 16px;
  padding: 12px;
  width: 100%;
  border-radius: 12px;
  border: 1px solid #ccc;
}

@media (max-width: 600px) {

  h1 {
    font-size: 22px;
    text-align: center;
  }

  button {
    width: 100%;
  }

  .circulos {
    gap: 10px;
  }

  #fechaHora {
    font-size: 12px;
    padding: 6px 10px;
  }
}


</style>
</head>

<body>

<div id="fechaHora"></div>

<h1 id="titulo">CONTROL DE ALUMNOS</h1>

<button onclick="irHome()">HOME</button>
<button onclick="irEstado()">Estado de alumnos</button>
<button onclick="irEntrenamientos()">ENTRENAMIENTOS</button>
<button onclick="cargarDesdeRepo()">Cargar base inicial</button>


<div id="contenido"></div>



<!-- MODAL -->
<div id="modal" class="modal oculto">
  <div class="modal-box">
    <span class="cerrar" onclick="cerrarModal()">X</span>
    <div id="modalBody"></div>
  </div>
</div>

<script>
/* =====================
   DATOS
===================== */
let alumnos = JSON.parse(localStorage.getItem("alumnos")) || [];
const PASSWORD = "1234";

function irHome() {
  window.location.href = "index.html";
}

function irEntrenamientos() {
  window.location.href = "ENTRENAMIENTOS.html";
}

/* =====================
   UTILIDADES
===================== */
function guardar() {
  localStorage.setItem("alumnos", JSON.stringify(alumnos));
}

const modal = document.getElementById("modal");
const modalBody = document.getElementById("modalBody");

function mostrarModal(html) {
  modalBody.innerHTML = html;
  modal.classList.remove("oculto");
}

function cerrarModal() {
  modal.classList.add("oculto");
}

function cargarDesdeRepo() {
  fetch("alumnos.json")
    .then(res => {
      if (!res.ok) throw new Error("No se pudo cargar alumnos.json");
      return res.json();
    })
    .then(data => {
      if (!Array.isArray(data)) {
        alert("El archivo JSON no es v√°lido");
        return;
      }

      alumnos = data;
      guardar();
      renderEstado();

      alert("‚úî Datos cargados desde el repositorio");
    })
    .catch(err => {
      alert("Error al cargar el archivo JSON");
      console.error(err);
    });
}

  
/* =====================
   CONTROL DE ALUMNOS
===================== */
function renderControl() {
  document.getElementById("titulo").innerText = "CONTROL DE ALUMNOS";
  const cont = document.getElementById("contenido");
  cont.innerHTML = "";

 /* ===== CUMPLEA√ëOS ===== */
  const cumpleanieros = alumnos.filter(cumplea√±osHoy);

  if (cumpleanieros.length > 0) {
    cumpleanieros.forEach(a => {
      const aviso = document.createElement("div");
      aviso.className = "fila";
      aviso.style.background = "#ffe0f0";
      aviso.style.border = "2px solid #e91e63";
      aviso.style.fontWeight = "bold";
      aviso.style.fontSize = "18px";
      aviso.style.justifyContent = "center";
      aviso.innerText = `üéâ HOY CUMPLE ${a.nombre} ${a.apellido} üéÇ`;
      cont.appendChild(aviso);
    });
  }

  alumnos.forEach(a => {
    const fila = document.createElement("div");
    fila.className = "fila";

    const nombre = document.createElement("div");
    nombre.className = "nombre";
    nombre.innerText = a.nombre + " " + a.apellido;

    const circ = document.createElement("div");
    circ.className = "circulos";


// üîí Normalizar circulos si no existen
if (!Array.isArray(a.circulos)) {
  a.circulos = [false, false, false, false, false];
}

    a.circulos.forEach((v, i) => {
      const c = document.createElement("div");
      c.className = "circulo" + (v ? " activo" : "");
      c.onclick = () => {
        a.circulos[i] = !a.circulos[i];
        guardar();
        renderControl();
      };
      circ.appendChild(c);
    });

    fila.appendChild(nombre);
    fila.appendChild(circ);
    cont.appendChild(fila);
  });
}

/* =====================
   ESTADO DE ALUMNOS
===================== */
function irEstado() {
  mostrarModal(`
    <h3>Contrase√±a</h3>
    <input id="pass" type="password">
    <br><br>
    <button onclick="login()">Ingresar</button>
  `);
}

function login() {
  const pass = document.getElementById("pass").value;
  if (pass !== PASSWORD) {
    alert("Contrase√±a incorrecta");
    return;
  }
  cerrarModal();
  renderEstado();
}

function renderEstado() {
  document.getElementById("titulo").innerText = "ESTADO DE ALUMNOS";
  const cont = document.getElementById("contenido");
  cont.innerHTML = `
    <button onclick="renderControl()">‚¨Ö Volver a CONTROL DE ALUMNOS</button>
    <br><br>

    <input 
    id="busqueda" 
    placeholder="Buscar alumno (nombre, apellido o tel√©fono)" 
    oninput="filtrarAlumnos()"
    style="padding:8px; width:260px; border-radius:10px; border:1px solid #ccc;"
  >    

    <button onclick="nuevoAlumno()">Nuevo alumno</button>
    <button onclick="importarJSON()">Importar JSON</button>
    <button onclick="exportar()">Exportar JSON</button>

<input 
  type="file" 
  id="inputJSON" 
  accept=".json" 
  style="display:none"
  onchange="leerJSON(this)"
>
    <hr>
  `;

   mostrarListado(alumnos);

}

function mostrarListado(lista) {
  const cont = document.getElementById("contenido");

  lista.forEach(a => {
    const fila = document.createElement("div");
    fila.className = "fila";
    fila.innerHTML = `
      <div class="nombre">${a.nombre} ${a.apellido}</div>
      <button onclick="editarAlumno(${a.id})">Editar Datos</button>
      <button onclick="verPagos(${a.id})">Historial de pagos</button>
      <button onclick="borrarAlumno(${a.id})">Borrar Alumno</button>
      <button onclick="pago(${a.id})">Nuevo Pago</button>
    `;
    cont.appendChild(fila);
  });
}

function filtrarAlumnos() {
  const texto = document.getElementById("busqueda").value.toLowerCase();

  const filtrados = alumnos.filter(a =>
    a.nombre.toLowerCase().includes(texto) ||
    a.apellido.toLowerCase().includes(texto) ||
    a.telefono.includes(texto)
  );

  const cont = document.getElementById("contenido");

  // Borra SOLO las filas (no los botones)
  cont.querySelectorAll(".fila").forEach(f => f.remove());

  mostrarListado(filtrados);
}



/* =====================
   ALUMNOS
===================== */
function nuevoAlumno() {
  mostrarModal(`
    <h3>Nuevo alumno</h3>
    <input id="nombre" placeholder="Nombre"><br><br>
    <input id="apellido" placeholder="Apellido"><br><br>
    <input id="telefono" placeholder="Tel√©fono"><br><br>
    <input id="FechaNacimiento" type="date"><br><br>

    <button onclick="guardarNuevo()">Guardar</button>
  `);
}

function guardarNuevo() {
  const nombre = document.getElementById("nombre").value;
  const apellido = document.getElementById("apellido").value;
  const telefono = document.getElementById("telefono").value;
  const FechaNacimiento = document.getElementById("FechaNacimiento").value;

  const repetido = alumnos.find(a =>
    (a.nombre === nombre && a.apellido === apellido) ||
    a.telefono === telefono
  );

  if (repetido && !confirm("Ya existe un alumno con esos datos. ¬øCrear igual?")) {
    return;
  }

  alumnos.unshift({
    id: Date.now(),
    nombre,
    apellido,
    telefono,
    FechaNacimiento,
    circulos: [true,false,false,false,false],
    pagos: []
  });

  guardar();
  cerrarModal();
  renderEstado();
}

/* =====================
   PAGOS
===================== */

function pago(id) {
  const hoy = new Date().toISOString().slice(0, 10);

  mostrarModal(`
    <h3>Nuevo pago</h3>

    <label>Fecha</label><br>
    <input id="fecha" type="date" value="${hoy}"><br><br>

    <label>Monto</label><br>
    <input id="monto" placeholder="Monto"><br><br>

    <button onclick="guardarPago(${id})">Guardar</button>
  `);
}

function guardarPago(id) {
  const monto = document.getElementById("monto").value;
  const fechaInput = document.getElementById("fecha").value;
  const alumno = alumnos.find(a => a.id === id);

  const fecha = fechaInput
    ? new Date(fechaInput).toLocaleDateString()
    : new Date().toLocaleDateString();

  alumno.pagos.push({
    fecha,
    monto
  });

  alumnos = alumnos.filter(a => a.id !== id);
  alumnos.unshift(alumno);

  guardar();
  cerrarModal();
  renderEstado();
}

/* =====================
   EXPORTAR
===================== */
function exportar() {
  const blob = new Blob(
    [JSON.stringify(alumnos, null, 2)],
    { type: "application/json" }
  );
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "alumnos.json";
  link.click();
}

function verPagos(id) {
  const alumno = alumnos.find(a => a.id === id);

  if (alumno.pagos.length === 0) {
    mostrarModal(`
      <h3>Historial de pagos</h3>
      <p><strong>√öltimo pago:</strong> Sin pagos registrados</p>
      <p><strong>Total pagado:</strong> $0</p>
    `);
    return;
  }

  let total = 0;
  const ultimoPago = alumno.pagos[alumno.pagos.length - 1].fecha;

  let html = `
    <h3>Historial de pagos</h3>
    <p><strong>√öltimo pago:</strong> ${ultimoPago}</p>
    <ul>
  `;

  alumno.pagos.forEach(p => {
    const monto = Number(p.monto) || 0;
    total += monto;
    html += `<li>${p.fecha} ‚Äî $${monto}</li>`;
  });

  html += `
    </ul>
    <hr>
    <p><strong>Total pagado:</strong> $${total}</p>
  `;

  mostrarModal(html);
}

function editarAlumno(id) {
  const alumno = alumnos.find(a => a.id === id);

  mostrarModal(`
    <h3>Editar alumno</h3>
    <input id="editNombre" value="${alumno.nombre}" placeholder="Nombre"><br><br>
    <input id="editApellido" value="${alumno.apellido}" placeholder="Apellido"><br><br>
    <input id="editTelefono" value="${alumno.telefono}" placeholder="Tel√©fono"><br><br>
    <input id="editFechaNacimiento" value="${alumno.FechaNacimiento || ''}" placeholder="Ingrese F.N."><br><br>
    <button onclick="guardarEdicion(${id})">Guardar cambios</button>
  `);
}

function guardarEdicion(id) {
  const nombre = document.getElementById("editNombre").value;
  const apellido = document.getElementById("editApellido").value;
  const telefono = document.getElementById("editTelefono").value;
  const FechaNacimiento = document.getElementById("editFechaNacimiento").value;

  const repetido = alumnos.find(a =>
    a.id !== id &&
    (
      (a.nombre === nombre && a.apellido === apellido) ||
      a.telefono === telefono
    )
  );

  if (repetido && !confirm("Ya existe un alumno con esos datos. ¬øGuardar igual?")) {
    return;
  }

  const alumno = alumnos.find(a => a.id === id);
  alumno.nombre = nombre;
  alumno.apellido = apellido;
  alumno.telefono = telefono;
  alumno.FechaNacimiento = FechaNacimiento;

  guardar();
  cerrarModal();
  renderEstado();
}

function borrarAlumno(id) {
  const alumno = alumnos.find(a => a.id === id);

  const confirmar = confirm(
    "¬øSeguro que quer√©s borrar a:\n\n" +
    alumno.nombre + " " + alumno.apellido +
    "\n\n‚ö† Esta acci√≥n no se puede deshacer."
  );

  if (!confirmar) return;

  alumnos = alumnos.filter(a => a.id !== id);
  guardar();
  renderEstado();
}

function cumplea√±osHoy(alumno) {
  if (!alumno.FechaNacimiento) return false;

  const hoy = new Date();
  const fn = new Date(alumno.FechaNacimiento);

  return (
    hoy.getDate() === fn.getDate() &&
    hoy.getMonth() === fn.getMonth()
  );
}

function actualizarFechaHora() {
  const ahora = new Date();

  const opciones = {
    timeZone: "America/Argentina/Buenos_Aires",
    weekday: "long",
    day: "numeric",
    month: "long",
    hour: "2-digit",
    minute: "2-digit",
    hour12: false
  };

  let texto = ahora.toLocaleString("es-AR", opciones);

  // Formato personalizado
  texto = texto
    .replace(",", "")
    .replace(":", ":") + " hs";

  texto = texto.toUpperCase();

  document.getElementById("fechaHora").innerText = texto;
}

// iniciar
actualizarFechaHora();
setInterval(actualizarFechaHora, 60000);

function importarJSON() {
  document.getElementById("inputJSON").click();
}

function leerJSON(input) {
  const archivo = input.files[0];
  if (!archivo) return;

  const reader = new FileReader();

  reader.onload = function(e) {
    try {
      const datos = JSON.parse(e.target.result);

      // Validaci√≥n m√≠nima
      if (!Array.isArray(datos)) {
        alert("El archivo no tiene un formato v√°lido de alumnos.");
        return;
      }

      if (!confirm("‚ö† Esto reemplazar√° TODOS los alumnos actuales.\n\n¬øDese√°s continuar?")) {
        input.value = "";
        return;
      }

      alumnos = datos;
      guardar();
      renderEstado();

      alert("‚úî Datos importados correctamente");

    } catch (error) {
      alert("Error al leer el archivo JSON.");
      console.error(error);
    }

    input.value = ""; // reset input
  };

  reader.readAsText(archivo);
}


/* INIT */
renderControl();
</script>

</body>
</html>
